<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>千行后台管理</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" type="text/css" href="http://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/font-awesome/4.6.0/css/font-awesome.min.css">
    <!-- Simplify -->
    <link href="css/simplify.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./layui/css/layui.css">
    <link rel="stylesheet" href="./css/back_base.css">
    <style>
        .top_box {
            margin-bottom: 10px;
            padding: 15px;
            line-height: 22px;
            border-left: 5px solid #009688;
            border-radius: 0 2px 2px 0;
            background-color: #e5e5e5;
        }
    </style>
</head>

<body class="overflow-hidden">
<div class="wrapper preload">

    <header class="top-nav">
        <div class="top-nav-inner">
            <div class="nav-header">
                <button type="button" class="navbar-toggle pull-left sidebar-toggle" id="sidebarToggleSM">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <ul class="nav-notification pull-right">
                    <li>
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-cog fa-lg"></i></a>
                        <span class="badge badge-danger bounceIn">1</span>
                        <ul class="dropdown-menu dropdown-sm pull-right user-dropdown">
                            <li class="user-avatar">
                                <img src="images/profile1.jpg" alt="" class="img-circle">
                                <div class="user-content">
                                    <h5 class="no-m-bottom">Jane Doe</h5>
                                    <div class="m-top-xs">
                                        <a href="profile.html" class="m-right-sm">Profile</a>
                                        <a href="">Log out</a>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <a href="">
                                    Inbox
                                    <span class="badge badge-danger bounceIn animation-delay2 pull-right">1</span>
                                </a>
                            </li>
                            <li>
                                <a href="#">
                                    Notification
                                    <span class="badge badge-purple bounceIn animation-delay3 pull-right">2</span>
                                </a>
                            </li>
                            <li>
                                <a href="#" class="sidebarRight-toggle">
                                    Message
                                    <span class="badge badge-success bounceIn animation-delay4 pull-right">7</span>
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="#">Setting</a>
                            </li>
                        </ul>
                    </li>
                </ul>

                <a href="back_index.html" class="brand">
                    <i class="fa fa-database"></i><span class="brand-name">千行后台管理</span>
                </a>
            </div>
            <div class="nav-container">
                <button type="button" class="navbar-toggle pull-left sidebar-toggle" id="sidebarToggleLG">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <ul class="nav-notification">
                    <li class="search-list">
                        <div class="search-input-wrapper">
                            <div class="search-input">
                                <input type="text" class="form-control input-sm inline-block">
                                <a href="#" class="input-icon text-normal"><i class="ion-ios7-search-strong"></i></a>
                            </div>
                        </div>
                    </li>
                </ul>
                <div class="pull-right m-right-sm">
                    <div class="user-block hidden-xs">
                        <a href="#" id="userToggle" data-toggle="dropdown">
                            <img src="images/profile1.jpg" alt="" class="img-circle inline-block user-profile-pic">
                            <div class="user-detail inline-block">
                                Jane Doe
                                <i class="fa fa-angle-down"></i>
                            </div>
                        </a>
                        <div class="panel border dropdown-menu user-panel">
                            <div class="panel-body paddingTB-sm">
                                <ul>
                                    <li>
                                        <a href="profile.html">
                                            <i class="fa fa-edit fa-lg"></i><span class="m-left-xs">My Profile</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="">
                                            <i class="fa fa-inbox fa-lg"></i><span class="m-left-xs">Inboxes</span>
                                            <span class="badge badge-danger bounceIn animation-delay3">2</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="">
                                            <i class="fa fa-power-off fa-lg"></i><span class="m-left-xs">Sign out</span>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <ul class="nav-notification">
                        <li>
                            <a href="#" data-toggle="dropdown"><i class="fa fa-envelope fa-lg"></i></a>
                            <span class="badge badge-purple bounceIn animation-delay5 active suggest"></span>
                            <ul class="dropdown-menu message pull-right sug_list">
                                <li><a>You have <span class="suggest"></span> new unread messages</a></li>

                                <!--<li>-->
                                <!--<a class="clearfix" href="#">-->
                                <!--<img src="images/profile1.jpg" alt="User Avatar">-->
                                <!--<div class="detail">-->
                                <!--<strong>Baby Doe</strong>-->
                                <!--<p class="no-margin">-->
                                <!--Lorem ipsum dolor sit amet...-->
                                <!--</p>-->
                                <!--<small class="text-muted"><i class="fa fa-reply"></i> 9 Feb 2013</small>-->
                                <!--</div>-->
                                <!--</a>-->
                                <!--</li>-->
                                <!--<li><a href="#">View all messages</a></li>-->
                            </ul>
                        </li>
                        <li>
                            <a href="#" data-toggle="dropdown"><i class="fa fa-bell fa-lg"></i></a>
                            <span class="badge badge-info bounceIn animation-delay6 active public"></span>
                            <ul class="dropdown-menu notification dropdown-3 pull-right pub_list">
                                <li><a href="#">You have <span class="public"></span> new notifications</a></li>

                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div><!-- ./top-nav-inner -->
    </header>
    <aside class="sidebar-menu fixed">
        <div class="sidebar-inner scrollable-sidebar">
            <div class="main-menu">
                <ul class="accordion">
                    <li class="menu-header">
                        Main Menu
                    </li>
                    <li class="bg-palette1">
                        <a href="back_index.html">
									<span class="menu-content block">
										<span class="menu-icon"><i class="block fa fa-home fa-lg"></i></span>
										<span class="text m-left-sm">主页</span>
									</span>
                            <span class="menu-content-hover block">
										Home
									</span>
                        </a>
                    </li>
                    <li class="bg-palette2">
                        <a href="#">
									<span class="menu-content block">
										<span class="menu-icon"><i class="block fa fa-desktop fa-lg"></i></span>
										<span class="text m-left-sm">控制台</span>
									</span>
                            <span class="menu-content-hover block">
										控制台
									</span>
                        </a>
                    </li>
                    <li class="openable bg-palette3">
                        <a href="#">
									<span class="menu-content block">
										<span class="menu-icon"><i class="block fa fa-list fa-lg"></i></span>
										<span class="text m-left-sm">新闻管理</span>
										<span class="submenu-icon"></span>
									</span>
                            <span class="menu-content-hover block">
										新闻管理
									</span>
                        </a>
                        <ul class="submenu bg-palette4">
                            <li><a href="back_newsList.html"><span class="submenu-label">新闻列表</span></a></li>
                            <li><a href="back_addNews.html"><span class="submenu-label">添加新闻</span></a></li>
                        </ul>
                    </li>
                    <li class="openable bg-palette4">
                        <a href="#">
									<span class="menu-content block">
										<span class="menu-icon"><i class="block fa fa-tags fa-lg"></i></span>
										<span class="text m-left-sm">产品管理</span>
										<span class="submenu-icon"></span>
									</span>
                            <span class="menu-content-hover block">
										产品管理
									</span>
                        </a>
                        <ul class="submenu">
                            <li><a href="back_productList.html"><span class="submenu-label">产品列表</span></a></li>
                            <li><a href="back_addProduct.html"><span class="submenu-label">产品添加</span></a></li>
                            <li><a href="back_addFDT.html"><span class="submenu-label">其他</span></a></li>
                        </ul>
                    </li>
                    <li class="bg-palette1">
                        <a href="">
									<span class="menu-content block">
										<span class="menu-icon"><i class="block fa fa-envelope fa-lg"></i></span>
										<span class="text m-left-sm">留言信息</span>
										<small class="badge badge-danger badge-square bounceIn animation-delay5 m-left-xs allSuggest"></small>
									</span>
                            <span class="menu-content-hover block">
										留言信息
									</span>
                        </a>
                    </li>
                    <li class="menu-header">
                        Others
                    </li>
                    <li class="openable bg-palette3">
                        <a href="#">
									<span class="menu-content block">
										<span class="menu-icon"><i class="block fa fa-gift fa-lg"></i></span>
										<span class="text m-left-sm">用户管理</span>
										<span class="submenu-icon"></span>
									</span>
                            <span class="menu-content-hover block">
										用户管理
									</span>
                        </a>
                        <ul class="submenu">
                            <li><a href=""><span class="submenu-label">管理员添加</span></a></li>
                            <li><a href=""><span class="submenu-label">基本信息</span></a></li>
                        </ul>
                    </li>
                    <li class="openable bg-palette4 open">
                        <a href="#">
									<span class="menu-content block">
										<span class="menu-icon"><i class="block fa fa-list fa-lg"></i></span>
										<span class="text m-left-sm">公告管理</span>
										<span class="submenu-icon"></span>
									</span>
                            <span class="menu-content-hover block">
										公告管理
									</span>
                        </a>
                        <ul class="submenu">
                            <li class="active"><a href="back_publicList.html"><span class="submenu-label">公告列表</span></a></li>
                            <li><a href="back_addPublic.html"><span class="submenu-label">公告添加</span></a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="sidebar-fix-bottom clearfix">
                <div class="user-dropdown dropup pull-left">
                    <a href="#" class="dropdwon-toggle font-18" data-toggle="dropdown"><i class="ion-person-add"></i>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="">
                                Inbox
                                <span class="badge badge-danger bounceIn animation-delay2 pull-right">1</span>
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                Notification
                                <span class="badge badge-purple bounceIn animation-delay3 pull-right">2</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" class="sidebarRight-toggle">
                                Message
                                <span class="badge badge-success bounceIn animation-delay4 pull-right">7</span>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">Setting</a>
                        </li>
                    </ul>
                </div>
                <a href="#" class="pull-right font-18"><i class="ion-log-out"></i></a>
            </div>
        </div><!-- sidebar-inner -->
    </aside>

    <div class="main-container">
        <!-- 内容主体区域 -->
        <div class="box_content">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>公告列表</legend>
            </fieldset>
            <div class="top_box">
                <div class="layui-input-inline">
                    <input type="text" class="layui-input input_text" placeholder="请输入关键字">
                </div>
                <button class="layui-btn search_btn">查询</button>
                <a class="layui-btn layui-btn-normal" href="./back_addNews.html">添加公告</a>
                <button class="layui-btn  layui-btn-danger" data-type="getCheckData">批量删除</button>
            </div>

            <table id="demo" lay-filter="test"></table>
        </div>
    </div><!-- /main-container -->

    <footer class="footer">
				<span class="footer-brand">
					<strong class="text-danger">千行</strong> 所有
				</span>
        <p class="no-margin">
            Copyright © 2014.Company name All rights reserved.
        </p>
    </footer>
</div><!-- /wrapper -->



<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->

<!-- Jquery -->
<script src="js/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="js/bootstrap.min.js"></script>


<!-- Slimscroll -->
<script src='js/jquery.slimscroll.min.js'></script>


<!-- Simplify -->
<script src="js/simplify.js"></script>
<!-- <script src="js/simplify/simplify_dashboard.js"></script> -->
<script src="./layui/layui.all.js"></script>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-sm edit" lay-event="edit" ><i class="layui-icon layui-icon-edit"></i> 编辑</a>
        <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del" ><i class="layui-icon layui-icon-delete"></i> 删除</a>
    </div>
</script>

<script>


    layui.use('table', function(){
        var table = layui.table;
        //第一个实例
        table.render({
            elem: '#demo'
            ,url: '/api/queryPublicByPage' //数据接口
            ,response: {
                statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
            }
            ,parseData:function (res) {
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "data": res.data, //解析数据列表
                    "count" : res.count
                }
            }
            ,limit: 10
            ,page: true //开启分页
            ,cols: [[ //表头
                {type:'numbers'}
                ,{type:'checkbox'}
                ,{field: 'id', title: 'ID', sort: true,width:60}
                ,{field: 'public_title', title: '公告标题',edit:"text"}
                ,{field: 'public_content', title: '公告内容',edit:"text"}
                ,{field: 'public_nowview', title: '浏览次数'}
                ,{field: 'public_ctime', title: '创建时间'}
                ,{field: 'right', title:'操作',toolbar: '#toolbarDemo' }
            ]]
            ,done: function (data) {
                if(data.msg == "Fail") {
                    window.location.href = "login.html"
                }
            }
        });
        //监听行工具事件
        table.on('tool(test)', function(obj){
            var data = obj.data;
            if(obj.event === 'del'){
                layer.confirm('真的删除行么', function(index){
                    $.ajax({
                        url: "/deletePublicById?id=" + data.id,
                        type: "get",
                        success: function (data) {
                            if(JSON.parse(data).msg === "删除成功") {
                                obj.del();
                            }
                        },
                        error: function (error) {
                            console.log(error)
                        }
                    })
                    layer.close(index);
                    layer.msg('成功删除一条数据！', {icon: 6});
                });
            } else if(obj.event === 'edit'){
                layer.prompt({
                    formType: 2
                    ,maxlength: 10000
                    ,area: ['500px', '350px']
                    ,title: '修改 ID 为 ['+ data.id +'] 的公告内容'
                    ,value: data.public_content
                }, function(value, index){
                    layer.close(index);
                    test(value,data.id);
                    //同步更新表格和缓存对应的值
                });
            }
        });
        //监听单元格编辑
        table.on('edit(test)', function(obj){
            var value = obj.value; //得到修改后的值
            var data = obj.data //得到所在行所有键值
            var field = obj.field; //得到字段
            var url = "/updatePublicById?id=" + data.id + "&change=" + field + "&value=" + value;
            $.ajax({
                url:url,
                type: "post",
                success : function (data) {
                    if(JSON.parse(data).msg === "更新成功") {
                        layer.msg('修改成功！', {icon: 6});
                    }
                },
                error: function(error) {
                    console.log(error)
                }
            })




        });

        var btn = layui.$(".search_btn");
        var errorCode = layui.$(".input_text");
        errorCode.on("keypress",function (e) {
            if(e.keyCode == 13) {
                btn.trigger("click");
            }

        })
        btn.on("click",function (e) {
            var blurText = $(".input_text").val();
            // if(blurText == "") {
            //     layer.msg('请输入需要查询的内容！');
            // } else {
            //     queryBlurNews(blurText);
            // }
                queryBlurNews(blurText);

        })
        // function queryBlurNews(blurText) {
        //     table.render({
        //         elem: '#demo'
        //         ,url: '/queryPublicByBlur?text=' + blurText //数据接口
        //         ,response: {
        //             statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
        //         }
        //         ,parseData:function (res) {
        //             return {
        //                 "code": res.status, //解析接口状态
        //                 "msg": res.msg, //解析提示文本
        //                 "data": res.data, //解析数据列表
        //                 "count" : res.count
        //             }
        //         }
        //         ,page: true //开启分页
        //         ,cols: [[ //表头
        //             {type:'numbers'}
        //             ,{type:'checkbox'}
        //             ,{field: 'id', title: 'ID', sort: true,width:60}
        //             ,{field: 'public_title', title: '公告标题',edit:"text"}
        //             ,{field: 'public_content', title: '公告内容',edit:"text"}
        //             ,{field: 'public_nowview', title: '浏览次数'}
        //             ,{field: 'public_ctime', title: '创建时间'}
        //             ,{field: 'right', title:'操作',toolbar: '#toolbarDemo' }
        //         ]]
        //     });
        // }
        function queryBlurNews(blurText) {
            table.reload('demo',{
                url:"/queryPublicByBlur?text=" + blurText
            })
        }

        var $ = layui.$, active = {
            getCheckData: function(){ //获取选中数据
                layer.confirm('是否确认删除选中数据？', {icon: 3, title:'警告框'}, function(index){
                    layer.close(index);
                    var checkStatus = table.checkStatus('demo')
                        ,data = checkStatus.data;
                    var arr = [];
                    var len = data.length;
                    for(var i = 0; i < len; i ++) {
                        arr.push(data[i].id)
                    }
                    if(len <= 0) {
                        layer.msg("请选中要删除的行！")
                    } else {
                        $.ajax({
                            url: "/deleteAllPublic",
                            type: "get",
                            // traditional :true,
                            data: {
                                listContentId:""+arr+""
                            },
                            dataType: "text",
                            success: function (data) {
                                layer.msg("成功删除" + len + "条数据", {icon: 1});
                                setTimeout(function () {
                                    window.location.href = "back_publicList.html";
                                },2000)
                            },
                            error: function (error) {
                                layer.msg("删除失败...", {icon: 2})
                            }
                        })
                    }
                });

            }
        };

        $('.layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
        function test(value,id) {
            var formData = new FormData();
            formData.append("content",value);
            //这里一般是发送修改的Ajax请求
            $.ajax({
                type:"get",
                url: "/updatePublicConById?id=" + id,
                // data:formData,
                data: {
                    "content":""+value+""
                },
                dataType: "text",
                success: function (data) {
                    layer.msg('更新成功！', {icon: 6});
                    table.reload('demo', {
                        page: {
                            curr: 1 //重新从第 1 页开始
                        }
                    });
                },
                error: function (error) {
                    console.log(error)
                }
            })
        }
    });




</script>


<script src="js/base_ajax.js"></script>


</body>
</html>
