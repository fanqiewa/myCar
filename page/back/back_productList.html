<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>产品列表</title>
    <link rel="stylesheet" href="./layui/css/layui.css">
    <link rel="stylesheet" href="./css/back_base.css">
    <style>
        .top_box {
            margin-bottom: 10px;
            padding: 15px;
            line-height: 22px;
            border-left: 5px solid #009688;
            border-radius: 0 2px 2px 0;
            background-color: #f2f2f2;
        }
    </style>
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <div class="layui-logo">layui 后台布局</div>
        <!-- 头部区域（可配合layui已有的水平导航） -->
        <ul class="layui-nav layui-layout-left">
            <li class="layui-nav-item"><a href="">控制台</a></li>
            <li class="layui-nav-item"><a href="">商品管理</a></li>
            <li class="layui-nav-item"><a href="">用户</a></li>
            <li class="layui-nav-item">
                <a href="javascript:;">其它系统</a>
                <dl class="layui-nav-child">
                    <dd><a href="">邮件管理</a></dd>
                    <dd><a href="">消息管理</a></dd>
                    <dd><a href="">授权管理</a></dd>
                </dl>
            </li>
        </ul>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item">
                <a href="javascript:;">
                    <img src="http://t.cn/RCzsdCq" class="layui-nav-img">
                    贤心
                </a>
                <dl class="layui-nav-child">
                    <dd><a href="">基本资料</a></dd>
                    <dd><a href="">安全设置</a></dd>
                </dl>
            </li>
            <li class="layui-nav-item"><a href="">退了</a></li>
        </ul>
    </div>

    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
            <ul class="layui-nav layui-nav-tree"  lay-filter="test">
                <li class="layui-nav-item layui-nav-itemed">
                    <a class="" href="javascript:;">产品管理</a>
                    <dl class="layui-nav-child">
                        <dd  class="layui-this"><a href="back_productList.html">产品列表</a></dd>
                        <dd><a href="back_addProduct.html">产品添加</a></dd>
                        <dd><a href="back_addFDT.html">外饰添加</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item">
                    <a href="javascript:;">新闻管理</a>
                    <dl class="layui-nav-child">
                        <dd><a href="back_newsList.html">新闻列表</a></dd>
                        <dd><a href="./back_addNews.html">新闻添加</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item"><a href="">云市场</a></li>
                <li class="layui-nav-item"><a href="">发布商品</a></li>
            </ul>
        </div>
    </div>

    <div class="layui-body">
        <!-- 内容主体区域 -->
        <div class="box_content">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>产品列表</legend>
            </fieldset>
            <div class="top_box">
                <div class="layui-input-inline">
                    <input type="text" class="layui-input input_text" placeholder="请输入关键字">
                </div>
                <button class="layui-btn search_btn">查询</button>
                <a class="layui-btn layui-btn-normal" href="./back_addNews.html">添加产品</a>
                <button class="layui-btn  layui-btn-danger" data-type="getCheckData">批量删除</button>
            </div>

            <table id="demo" lay-filter="test"></table>
        </div>
    </div>

    <div class="layui-footer">
        <!-- 底部固定区域 -->
        © layui.com - 底部固定区域
    </div>
</div>

<script src="./layui/jquery.min.js"></script>
<script src="./layui/layui.all.js"></script>

<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
        <a class="layui-btn layui-btn-sm edit" lay-event="edit" ><i class="layui-icon layui-icon-edit"></i> 编辑</a>
        <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="del" ><i class="layui-icon layui-icon-delete"></i> 删除</a>
    </div>
</script>
<script>

    layui.use('table', function(){
        var table = layui.table;
        //第一个实例
        table.render({
            elem: '#demo'
            ,url: '/queryProductByPage' //数据接口
            ,response: {
                statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
            }
            ,parseData:function (res) {
                return {
                    "code": res.status, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "data": res.data, //解析数据列表
                    "count" : res.count
                }
            }
            ,limit: 10
            ,page: true //开启分页
            ,cols: [[ //表头
                {type:'numbers'}
                ,{type:'checkbox'}
                ,{field: 'id', title: 'ID', sort: true,width:60}
                ,{field: 'category_name', title: '所属类别'}
                ,{field: 'product_price', title: '产品价格',edit:"text"}
                ,{field: 'product_describe', title: '一句话描述',edit:"text"}
                ,{field: 'product_version', title: '产品型号'}
                ,{field: 'right', title:'操作',toolbar: '#toolbarDemo' }
            ]]
        });
        //监听行工具事件
        table.on('tool(test)', function(obj){
            var data = obj.data;
            if(obj.event === 'del'){
                layer.confirm('真的删除行么', function(index){
                    var flag = true;
                    $.ajax({
                        url: "/deleteProductById?id=" + data.id,
                        type: "get",
                        success: function (data) {
                            if(JSON.parse(data).msg === "删除成功") {
                                console.log(false)
                                flag = false;
                                layer.msg('成功删除一条数据！', {icon: 6});
                                obj.del();
                            } else {
                                layer.msg('删除失败！', {icon: 5});
                            }
                        },
                        error: function (error) {
                            console.log(error)
                        }
                    })
                    layer.close(index);
                    var demo;
                    setTimeout(function () {
                        if(flag) {
                            demo = layer.load(0, {time: 10*1000}); //又换了种风格，并且设定最长等待10秒
                        }
                    },100);
                    setTimeout(function () {
                        if(flag) {
                            layer.close(demo);
                            layer.msg("删除失败！",{icon:5})
                        }
                    },1000)
                });
            } else if(obj.event === 'edit'){
                layer.prompt({
                    formType: 2
                    ,maxlength: 10000
                    ,area: ['500px', '350px']
                    ,title: '修改 ID 为 ['+ data.id +'] 的产品介绍'
                    ,value: data.product_introduction
                }, function(value, index){
                    layer.close(index);
                    test(value,data.id);
                    //同步更新表格和缓存对应的值
                });
            }
        });
        //监听单元格编辑
        table.on('edit(test)', function(obj){
            var value = obj.value; //得到修改后的值
            var data = obj.data //得到所在行所有键值
            var field = obj.field; //得到字段
            var url = "/updateProductById?id=" + data.id + "&change=" + field + "&value=" + value;
            $.ajax({
                url:url,
                type: "post",
                success : function (data) {
                    if(JSON.parse(data).msg === "更新成功") {
                        layer.msg('修改成功！', {icon: 6});
                    }
                },
                error: function(error) {
                    console.log(error)
                }
            })




        });

        var btn = layui.$(".search_btn");
        var errorCode = layui.$(".input_text");
        errorCode.on("keypress",function (e) {
            if(e.keyCode == 13) {
                btn.trigger("click");
            }

        })
        btn.on("click",function (e) {
            var blurText = $(".input_text").val();
            if(blurText == "") {
                layer.msg('请输入需要查询的内容！');
            } else {
                queryBlurNews(blurText);
            }
        })
        function queryBlurNews(blurText) {
            table.render({
                elem: '#demo'
                ,url: '/queryProductByBlur?text=' + blurText //数据接口
                ,response: {
                    statusCode: 200 //重新规定成功的状态码为 200，table 组件默认为 0
                }
                ,parseData:function (res) {
                    return {
                        "code": res.status, //解析接口状态
                        "msg": res.msg, //解析提示文本
                        "data": res.data, //解析数据列表
                        "count" : res.count
                    }
                }
                ,page: true //开启分页
                ,cols: [[ //表头
                    {type:'numbers'}
                    ,{type:'checkbox'}
                    ,{field: 'id', title: 'ID', sort: true,width:60}
                    ,{field: 'category_name', title: '所属类别'}
                    ,{field: 'product_price', title: '产品价格',edit:"text"}
                    ,{field: 'product_describe', title: '一句话描述',edit:"text"}
                    ,{field: 'product_version', title: '产品型号'}
                    ,{field: 'right', title:'操作',toolbar: '#toolbarDemo' }
                ]]
                ,done: function (data) {
                    if(data.data.length > 0) {
                        layer.msg("查询到" + data.data.length + "条数据",{icon:6})
                    } else {
                        layer.msg("查询到" + data.data.length + "条数据",{icon:5})
                    }
                }
            });
        }

        var $ = layui.$, active = {
            getCheckData: function(){ //获取选中数据
                layer.confirm('是否确认删除选中数据？', {icon: 3, title:'警告框'}, function(index){
                    layer.close(index);
                    var checkStatus = table.checkStatus('demo')
                        ,data = checkStatus.data;
                    var arr = [];
                    var len = data.length;
                    console.log(len)
                    for(var i = 0; i < len; i ++) {
                        arr.push(data[i].id)
                    }
                   if(len <= 0 ) {
                       layer.msg("请选中要删除的行")
                   } else {
                       $.ajax({
                           url: "/deleteAllProduct",
                           type: "get",
                           // traditional :true,
                           data: {
                               listContentId:""+arr+""
                           },
                           dataType: "text",
                           success: function (data) {
                               layer.msg("成功删除" + len + "条数据", {icon: 1});
                               setTimeout(function () {
                                   window.location.href = "back_productList.html";
                               },2000)
                           },
                           error: function (error) {
                               layer.msg("删除失败...", {icon: 2})
                           }
                       })
                   }
                });

            }
        };

        $('.layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });

    function test(value,id) {
        var formData = new FormData();
        formData.append("content",value);
        //这里一般是发送修改的Ajax请求
        $.ajax({
            type:"get",
            url: "/updateProductConById?id=" + id,
            // data:formData,
            data: {
                "content":""+value+""
            },
            dataType: "text",
            success: function (data) {
                layer.msg('更新成功！', {icon: 6});
            },
            error: function (error) {
                console.log(error)
            }
        })
    }

</script>
</body>
</html>
